---
phase: 01-foundation-data-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - frontend/src/app/(auth)/login/page.tsx
  - frontend/src/app/(auth)/signup/page.tsx
  - frontend/src/app/(auth)/reset-password/page.tsx
  - frontend/src/app/(auth)/layout.tsx
  - frontend/src/app/auth/callback/route.ts
  - frontend/src/middleware.ts
  - frontend/src/components/auth/AuthForm.tsx
  - frontend/src/components/auth/LogoutButton.tsx
  - frontend/src/hooks/useAuth.ts
  - frontend/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new account with email and password from the signup page"
    - "User can log in with existing email and password from the login page"
    - "User can log out and is redirected to the login page"
    - "User can request a password reset email from the reset-password page"
    - "User stays logged in when closing and reopening the browser"
    - "Unauthenticated users accessing protected routes are redirected to login"
  artifacts:
    - path: "frontend/src/app/(auth)/login/page.tsx"
      provides: "Login page with email/password form"
      min_lines: 30
    - path: "frontend/src/app/(auth)/signup/page.tsx"
      provides: "Signup page with email/password form"
      min_lines: 30
    - path: "frontend/src/app/(auth)/reset-password/page.tsx"
      provides: "Password reset request page"
      min_lines: 20
    - path: "frontend/src/middleware.ts"
      provides: "Auth middleware for session refresh and route protection"
      contains: "updateSession"
    - path: "frontend/src/hooks/useAuth.ts"
      provides: "Auth hook exposing user state and auth methods"
      exports: ["useAuth"]
    - path: "frontend/src/app/auth/callback/route.ts"
      provides: "OAuth/magic link callback handler"
      contains: "exchangeCodeForSession"
  key_links:
    - from: "frontend/src/app/(auth)/login/page.tsx"
      to: "Supabase auth"
      via: "supabase.auth.signInWithPassword"
      pattern: "signInWithPassword"
    - from: "frontend/src/app/(auth)/signup/page.tsx"
      to: "Supabase auth"
      via: "supabase.auth.signUp"
      pattern: "signUp"
    - from: "frontend/src/middleware.ts"
      to: "frontend/src/lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "updateSession"
    - from: "frontend/src/app/auth/callback/route.ts"
      to: "Supabase auth"
      via: "exchangeCodeForSession"
      pattern: "exchangeCodeForSession"
---

<objective>
Implement the complete authentication flow: signup, login, logout, password reset, session persistence, and route protection using Supabase Auth.

Purpose: Users need accounts before they can rate movies or receive personalized recommendations. Auth is the foundation for all user-specific features in later phases.

Output: Working auth pages (login, signup, reset-password), auth callback handler, middleware for session refresh, useAuth hook, and logout functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build auth pages, callback route, and reusable AuthForm component</name>
  <files>
    frontend/src/app/(auth)/layout.tsx
    frontend/src/app/(auth)/login/page.tsx
    frontend/src/app/(auth)/signup/page.tsx
    frontend/src/app/(auth)/reset-password/page.tsx
    frontend/src/app/auth/callback/route.ts
    frontend/src/components/auth/AuthForm.tsx
  </files>
  <action>
    Create a reusable auth form component and three auth pages using Next.js App Router route groups.

    `frontend/src/components/auth/AuthForm.tsx`:
    - Client component ("use client")
    - Props: `mode: "login" | "signup" | "reset"`, optional `onSubmit` override
    - Renders: email input, password input (hidden for reset mode), submit button, error message display, loading state
    - Styled with Tailwind: dark card on slate-800 background, rounded-lg, max-w-md centered, inputs with slate-700 bg and slate-300 text, accent-colored submit button (use red-600 for Netflix feel)
    - Includes links: login page links to signup and reset-password; signup links to login; reset links to login
    - Form state managed with useState: email, password, error, loading, successMessage
    - On submit: calls the appropriate Supabase auth method based on mode:
      - login: `supabase.auth.signInWithPassword({ email, password })`
      - signup: `supabase.auth.signUp({ email, password, options: { emailRedirectTo: \`${window.location.origin}/auth/callback\` } })`
      - reset: `supabase.auth.resetPasswordForEmail(email, { redirectTo: \`${window.location.origin}/auth/callback\` })`
    - On success: login redirects to `/browse` via `router.push`; signup shows "Check your email for confirmation"; reset shows "Check your email for reset link"
    - On error: displays Supabase error.message in red text below form
    - Uses `createClient` from `@/lib/supabase/client` for browser-side auth calls

    `frontend/src/app/(auth)/layout.tsx`:
    - Centered layout wrapper for auth pages
    - Full viewport height, flex column, centered content
    - NetflixRecs logo/title at top (text-3xl font-bold text-red-600)
    - Renders `{children}` below

    `frontend/src/app/(auth)/login/page.tsx`:
    - Server component page that renders `<AuthForm mode="login" />`
    - Page metadata: title "Login - NetflixRecs"

    `frontend/src/app/(auth)/signup/page.tsx`:
    - Server component page that renders `<AuthForm mode="signup" />`
    - Page metadata: title "Sign Up - NetflixRecs"

    `frontend/src/app/(auth)/reset-password/page.tsx`:
    - Server component page that renders `<AuthForm mode="reset" />`
    - Page metadata: title "Reset Password - NetflixRecs"

    `frontend/src/app/auth/callback/route.ts`:
    - Next.js Route Handler (GET) for Supabase auth callbacks (email confirmation, password reset)
    - Extracts `code` from URL search params
    - If code exists: creates server Supabase client, calls `supabase.auth.exchangeCodeForSession(code)`
    - Redirects to `/browse` on success, `/login?error=auth` on failure
    - If no code: redirects to `/login`
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes with no type errors
    - All auth pages render at /login, /signup, /reset-password (visually: dark card with form fields)
    - Auth callback route exists at /auth/callback
  </verify>
  <done>Three auth pages (login, signup, reset-password) render with styled forms. Auth callback route handles email confirmations and password resets. AuthForm component handles all three modes with appropriate Supabase auth calls.</done>
</task>

<task type="auto">
  <name>Task 2: Implement auth middleware, useAuth hook, logout, and session persistence</name>
  <files>
    frontend/src/middleware.ts
    frontend/src/hooks/useAuth.ts
    frontend/src/components/auth/LogoutButton.tsx
    frontend/src/app/layout.tsx
  </files>
  <action>
    Create root middleware for session refresh and route protection:

    `frontend/src/middleware.ts`:
    - Import `updateSession` from `@/lib/supabase/middleware` (created in Plan 01)
    - Export async `middleware(request)` that calls `updateSession(request)` -- this refreshes the Supabase session on every request, keeping the user logged in
    - Export `config.matcher` that matches all routes EXCEPT: `_next/static`, `_next/image`, `favicon.ico`, and static file extensions (svg, png, jpg, etc.)
    - The middleware does NOT block unauthenticated users from /login, /signup, /reset-password -- those are public
    - For protected routes (everything under /browse, /movies, /profile, /), check if user session exists via the Supabase client in middleware. If no session and route is protected, redirect to /login

    Create useAuth hook for client components:

    `frontend/src/hooks/useAuth.ts`:
    - Client-side hook ("use client" context)
    - Uses `createClient` from `@/lib/supabase/client`
    - Returns: `{ user, loading, signOut }`
    - On mount: calls `supabase.auth.getUser()` to get initial user state, sets loading=false when done
    - Subscribes to `supabase.auth.onAuthStateChange` to track login/logout events, updates user state reactively
    - `signOut`: calls `supabase.auth.signOut()` then redirects to `/login` via `router.push`
    - Cleans up auth subscription on unmount

    Create LogoutButton component:

    `frontend/src/components/auth/LogoutButton.tsx`:
    - Client component using `useAuth` hook
    - Renders a "Sign Out" button (Tailwind: text-sm text-slate-400 hover:text-white transition)
    - On click: calls `signOut()` from useAuth

    Update root layout:

    `frontend/src/app/layout.tsx`:
    - Wrap the app with TanStack Query's `QueryClientProvider` (create a client-side Providers component)
    - Create `frontend/src/app/providers.tsx` ("use client") that wraps children with `QueryClientProvider`
    - The layout imports and uses `<Providers>{children}</Providers>`
    - Do NOT add a global navbar yet (that comes in Plan 05 when browse page is built)
    - Ensure the html element has `lang="en"` and `className="dark"`
    - Keep the dark body styles from Plan 01
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes with no type errors
    - Middleware runs on page navigation (verify by checking middleware.ts matcher config)
    - `useAuth` hook can be imported: `import { useAuth } from "@/hooks/useAuth"`
    - Root layout wraps app with QueryClientProvider
  </verify>
  <done>Auth middleware refreshes sessions on every request and protects routes. useAuth hook provides reactive user state and signOut method. LogoutButton component renders and calls signOut. Root layout includes TanStack Query provider. Session persistence works via Supabase refresh tokens managed by middleware.</done>
</task>

</tasks>

<verification>
- TypeScript compiles cleanly: `cd frontend && npx tsc --noEmit`
- Login page renders at /login with email and password fields
- Signup page renders at /signup with email and password fields
- Reset password page renders at /reset-password with email field
- Auth callback route exists at /auth/callback
- Middleware intercepts requests (check middleware.ts config.matcher)
- useAuth hook exports user, loading, signOut
- LogoutButton component renders "Sign Out" button
- Root layout includes TanStack Query provider
</verification>

<success_criteria>
1. User can navigate to /signup and see a styled email/password form on dark background
2. User can navigate to /login and see a styled email/password form with link to signup and reset
3. User can navigate to /reset-password and request a password reset email
4. Auth callback route handles email confirmation redirects
5. Middleware refreshes Supabase session on every request (session persistence)
6. Protected routes redirect unauthenticated users to /login
7. useAuth hook provides user state and signOut for any client component
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-infrastructure/01-03-SUMMARY.md`
</output>
