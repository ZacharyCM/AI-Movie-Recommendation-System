---
phase: 03-content-based-recommendations
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useRecommendations.ts
  - frontend/src/hooks/useRatings.ts
  - frontend/src/components/recommendations/RecommendationSection.tsx
  - frontend/src/app/browse/page.tsx
autonomous: true

must_haves:
  truths:
    - "User with 5+ ratings sees a 'Recommended for You' section on the browse page above the movie grid"
    - "Recommendation cards are clickable and navigate to movie detail pages"
    - "User with < 5 ratings sees a fallback message encouraging them to rate more movies"
    - "Recommendations refresh automatically after user rates a new movie"
    - "Recommendation section shows loading skeleton while fetching"
  artifacts:
    - path: "frontend/src/lib/api.ts"
      provides: "fetchRecommendations() function that calls backend with auth token"
      contains: "fetchRecommendations"
    - path: "frontend/src/hooks/useRecommendations.ts"
      provides: "useRecommendations() TanStack Query hook"
      contains: "useRecommendations"
    - path: "frontend/src/components/recommendations/RecommendationSection.tsx"
      provides: "RecommendationSection component rendering horizontal scroll of movie cards"
      min_lines: 40
    - path: "frontend/src/app/browse/page.tsx"
      provides: "Browse page with RecommendationSection above MovieGrid"
      contains: "RecommendationSection"
  key_links:
    - from: "frontend/src/lib/api.ts"
      to: "/api/recommendations"
      via: "fetch with Authorization Bearer token"
      pattern: "api/recommendations.*Authorization"
    - from: "frontend/src/hooks/useRecommendations.ts"
      to: "frontend/src/lib/api.ts"
      via: "fetchRecommendations in queryFn"
      pattern: "fetchRecommendations"
    - from: "frontend/src/hooks/useRatings.ts"
      to: "frontend/src/hooks/useRecommendations.ts"
      via: "invalidateQueries recommendations on rating mutation settle"
      pattern: "invalidateQueries.*recommendations"
    - from: "frontend/src/app/browse/page.tsx"
      to: "frontend/src/components/recommendations/RecommendationSection.tsx"
      via: "component import and render"
      pattern: "RecommendationSection"
---

<objective>
Build the frontend recommendations UI: a "Recommended for You" section on the browse page that displays personalized movie recommendations from the backend API, with loading states, cold-start fallback messaging, and automatic refresh after new ratings.

Purpose: This connects the recommendation engine to the user experience. Users see personalized suggestions prominently on the browse page, making the app feel intelligent and tailored.

Output: RecommendationSection component integrated into the browse page, with TanStack Query hook for data fetching and automatic cache invalidation when ratings change.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-based-recommendations/03-RESEARCH.md
@.planning/phases/03-content-based-recommendations/03-01-SUMMARY.md
@frontend/src/lib/api.ts
@frontend/src/hooks/useRatings.ts
@frontend/src/types/movie.ts
@frontend/src/app/browse/page.tsx
@frontend/src/components/movies/MovieCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API Client, Hook, and RecommendationSection Component</name>
  <files>
    frontend/src/lib/api.ts
    frontend/src/hooks/useRecommendations.ts
    frontend/src/components/recommendations/RecommendationSection.tsx
  </files>
  <action>
**1. Update frontend/src/lib/api.ts** -- Add recommendation fetch function:
```typescript
export interface Recommendation {
  movie_id: number;
  title: string;
  poster_path: string | null;
  overview: string;
  vote_average: number;
  release_date: string;
  score: number;
  reason: string;
}

export interface RecommendationList {
  recommendations: Recommendation[];
  strategy: string;
  total_ratings: number;
}

export async function fetchRecommendations(
  accessToken: string,
  topN: number = 10
): Promise<RecommendationList> {
  const res = await fetch(
    `${API_URL}/api/recommendations?top_n=${topN}`,
    {
      cache: "no-store",
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    }
  );
  if (!res.ok) throw new Error(res.statusText);
  return res.json();
}
```

The accessToken is the Supabase JWT from the user's session. This is obtained via `supabase.auth.getSession()`.

**2. Create frontend/src/hooks/useRecommendations.ts** -- TanStack Query hook:
- Import `useQuery` from TanStack Query
- Import `fetchRecommendations` from `@/lib/api`
- Import `createClient` from `@/lib/supabase/client`
- Create `useRecommendations(topN: number = 10)` hook:
  - Use `useQuery` with queryKey `['recommendations']`
  - In queryFn: get Supabase client, call `supabase.auth.getSession()`, extract `session.access_token`, pass to `fetchRecommendations(token, topN)`
  - Set `enabled` to true (always try -- the backend handles auth errors)
  - Set `staleTime: 1000 * 60 * 5` (5 minutes -- recommendations don't change unless user rates something, and we invalidate on rating)
  - Set `retry: false` (don't retry auth failures or 503s)
- Export the hook

**3. Create frontend/src/components/recommendations/RecommendationSection.tsx** -- UI component:
- Client component ("use client")
- Import `useRecommendations` hook
- Import `MovieCard` from `@/components/movies/MovieCard`
- Import `Movie` type from `@/types/movie`
- The component renders:
  - **Loading state**: Show a section title "Recommended for You" with 5 skeleton cards (gray pulsing rectangles matching MovieCard aspect ratio) in a horizontal scrollable row
  - **Error state / 503**: Show nothing (silently hide -- don't break the browse experience if model isn't loaded)
  - **Content-based strategy**: Show section title "Recommended for You" with a horizontal scrollable row of MovieCard components. Map each recommendation to a Movie object (movie_id -> id, include title, poster_path, overview, vote_average, release_date, and set genre_ids to empty array, vote_count to 0, backdrop_path to null since we don't have these from the recommendation response).
  - **Popularity fallback strategy**: Show section title "Popular Right Now" (not "Recommended for You" -- be honest about what the user is seeing) with the same horizontal scroll layout. Below the title, add subtle text: "Rate 5+ movies to get personalized recommendations" in slate-400.
  - **Empty recommendations**: If strategy is content_based but recommendations array is empty, show message: "We're still learning your taste. Keep rating movies!"

- Horizontal scroll layout: Use `overflow-x-auto` with flex row, each card taking `min-w-[180px] w-[180px]` (fixed width cards). Add `gap-4` between cards. Hide scrollbar with CSS (`scrollbar-hide` utility or manual CSS).
- The section should have bottom margin to separate from the main movie grid below it.
  </action>
  <verify>
- `cd /Users/zacharym/netflixrecs/frontend && npx tsc --noEmit` passes without type errors
- Verify `fetchRecommendations` function exists in api.ts with correct signature
- Verify `useRecommendations` hook exists and uses TanStack Query
- Verify `RecommendationSection.tsx` imports MovieCard and useRecommendations
  </verify>
  <done>
- api.ts exports fetchRecommendations() with auth token parameter
- useRecommendations hook fetches from backend with Supabase JWT, has 5-min stale time
- RecommendationSection renders horizontal scroll of MovieCards for content_based strategy
- Popularity fallback shows "Popular Right Now" title with "rate more" prompt
- Loading state shows skeleton cards, error state silently hides
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Recommendations into Browse Page and Wire Cache Invalidation</name>
  <files>
    frontend/src/app/browse/page.tsx
    frontend/src/hooks/useRatings.ts
  </files>
  <action>
**1. Update frontend/src/app/browse/page.tsx** -- Add RecommendationSection:
- Import `RecommendationSection` from `@/components/recommendations/RecommendationSection`
- Render `<RecommendationSection />` ABOVE the existing search bar and movie grid
- Wrap it in a section with appropriate spacing (mb-8 or similar)
- The RecommendationSection is self-contained (fetches its own data via hook), so no props needed
- Keep the rest of the browse page (search, movie grid, pagination) exactly as-is

**2. Update frontend/src/hooks/useRatings.ts** -- Invalidate recommendations on rating change:
- In the `useRateMovie()` hook's `onSettled` callback, add:
  ```typescript
  queryClient.invalidateQueries({ queryKey: ['recommendations'] });
  ```
  This ensures that after a user rates a movie, the recommendations section re-fetches fresh results from the backend.
- Place this INSIDE the existing `if (queryClient.isMutating({ mutationKey: ['ratings'] }) === 1)` block, alongside the existing invalidations for ratings and user-stats. This way recommendations only invalidate after the last pending rating mutation settles, preventing redundant fetches during rapid rating changes.
  </action>
  <verify>
- `cd /Users/zacharym/netflixrecs/frontend && npx tsc --noEmit` passes without type errors
- Browse page source includes `<RecommendationSection` component
- useRatings.ts onSettled includes `invalidateQueries.*recommendations`
- Start dev server (`npm run dev`) and visit /browse -- RecommendationSection should render (may show loading/error if backend isn't running, but should not crash)
  </verify>
  <done>
- Browse page shows RecommendationSection above the movie grid
- Rating a movie triggers recommendation cache invalidation, causing fresh fetch
- Page does not crash if backend recommendation endpoint is unavailable
- Existing browse functionality (search, pagination) remains intact
  </done>
</task>

</tasks>

<verification>
1. Browse page at /browse shows "Recommended for You" section (or "Popular Right Now" for cold-start users) above the movie grid
2. Recommendation cards are MovieCard components -- clickable, show poster, title, rating
3. With backend running and model loaded, user with 5+ ratings sees personalized content-based recommendations
4. User with < 5 ratings sees popularity fallback with "Rate 5+ movies" prompt
5. After rating a new movie on the browse page, recommendations re-fetch automatically
6. Search and pagination continue to work as before
7. If backend is down, the RecommendationSection gracefully hides without breaking the page
</verification>

<success_criteria>
- "Recommended for You" section visible on browse page for users with 5+ ratings
- Recommendations reflect user's taste (genres/themes of highly-rated movies)
- Cold-start fallback shows popular movies with helpful messaging
- Recommendations refresh after new ratings without page reload
- No regressions in existing browse functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-based-recommendations/03-02-SUMMARY.md`
</output>
