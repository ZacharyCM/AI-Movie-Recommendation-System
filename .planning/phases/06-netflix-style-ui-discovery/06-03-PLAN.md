---
phase: 06-netflix-style-ui-discovery
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - frontend/src/components/discovery/MoodSelector.tsx
  - frontend/src/components/movies/Carousel.tsx
  - frontend/src/app/browse/page.tsx
  - frontend/src/hooks/useMoodRecommendations.ts
  - frontend/src/lib/api.ts
  - backend/routers/recommendations.py
  - backend/routers/movies.py
  - frontend/src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "User can see a mood selector UI with at least 5 mood options on the browse page"
    - "Selecting a mood shows a carousel of movies filtered to match that mood"
    - "Mood options map to genre combinations (e.g., 'adventurous' -> action/adventure, 'cozy' -> drama/romance/family)"
    - "User can deselect their mood to hide the mood-filtered carousel"
    - "Dark mode is consistently enforced across the entire application"
  artifacts:
    - path: "frontend/src/components/discovery/MoodSelector.tsx"
      provides: "Mood selection UI with emoji-labeled mood buttons"
      min_lines: 40
    - path: "backend/routers/movies.py"
      provides: "GET /api/movies/mood/{mood} endpoint"
      exports: ["get_movies_by_mood"]
    - path: "frontend/src/hooks/useMoodRecommendations.ts"
      provides: "TanStack Query hook for mood-based movie fetching"
      min_lines: 10
  key_links:
    - from: "frontend/src/components/discovery/MoodSelector.tsx"
      to: "frontend/src/app/browse/page.tsx"
      via: "component rendered in browse page with onMoodSelect callback"
      pattern: "MoodSelector"
    - from: "frontend/src/hooks/useMoodRecommendations.ts"
      to: "/api/movies/mood"
      via: "fetch"
      pattern: "api/movies/mood"
    - from: "backend/routers/movies.py"
      to: "TMDB discover API"
      via: "genre combination query"
      pattern: "with_genres"
---

<objective>
Add mood-based discovery that lets users select a mood and receive filtered movie recommendations, plus final dark mode consistency polish.

Purpose: REQ-DISC-01 requires mood-based discovery where users select a mood and get matching recommendations. REQ-UI-03 requires consistent dark mode across the entire application. This plan adds the mood selector UI with mapped genre filtering and audits dark mode enforcement globally.

Output: Mood selector on browse page with genre-mapped movie filtering, plus global dark mode consistency.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-netflix-style-ui-discovery/06-02-SUMMARY.md
@frontend/src/app/browse/page.tsx
@frontend/src/components/movies/Carousel.tsx
@frontend/src/lib/api.ts
@frontend/src/app/globals.css
@frontend/src/app/layout.tsx
@backend/routers/movies.py
@backend/services/tmdb.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mood-based discovery backend + frontend hook</name>
  <files>
    backend/routers/movies.py
    backend/services/tmdb.py
    frontend/src/lib/api.ts
    frontend/src/hooks/useMoodRecommendations.ts
  </files>
  <action>
    1. In `backend/routers/movies.py`, add endpoint `GET /api/movies/mood/{mood}` BEFORE the `/{movie_id}` catch-all:
       - Accepts mood as path param (string), page as query param (default 1)
       - Define a MOOD_GENRE_MAP dictionary mapping mood strings to TMDB genre ID lists:
         ```python
         MOOD_GENRE_MAP = {
             "adventurous": [28, 12],        # Action, Adventure
             "cozy": [18, 10749, 10751],      # Drama, Romance, Family
             "thrilling": [53, 27, 9648],     # Thriller, Horror, Mystery
             "mindblowing": [878, 14],         # Science Fiction, Fantasy
             "funny": [35, 10751],             # Comedy, Family
             "romantic": [10749, 18],          # Romance, Drama
             "nostalgic": [16, 10751, 12],     # Animation, Family, Adventure
             "intense": [28, 80, 53],          # Action, Crime, Thriller
         }
         ```
       - If mood not in map, raise HTTPException 400 with available moods list
       - Call the existing `tmdb_service.discover_by_genre()` but pass genre IDs as comma-separated string (TMDB discover API accepts `with_genres=28,12` for AND logic -- use `|` for OR: `with_genres=28|12`)
       - Update `discover_by_genre` in tmdb.py to accept a string of genre IDs (not just single int). Rename to `discover_by_genres(self, genre_ids: str, page: int = 1)` -- the genre_ids param is already a formatted string like "28|12". Update the existing genre/{genre_id} endpoint to call `discover_by_genres(str(genre_id), page)`.
       - Sort by popularity.desc, vote_count.gte=100 to filter quality
       - Returns PaginatedMovieResponse
       - Also add a `GET /api/movies/moods` endpoint that returns the available mood list with labels and emoji:
         ```python
         MOOD_LABELS = {
             "adventurous": {"label": "Adventurous", "emoji": "üó∫Ô∏è"},
             "cozy": {"label": "Something Cozy", "emoji": "‚òï"},
             "thrilling": {"label": "Edge of My Seat", "emoji": "üò±"},
             "mindblowing": {"label": "Mind-Blowing", "emoji": "ü§Ø"},
             "funny": {"label": "Make Me Laugh", "emoji": "üòÇ"},
             "romantic": {"label": "Feeling Romantic", "emoji": "üíï"},
             "nostalgic": {"label": "Feeling Nostalgic", "emoji": "‚ú®"},
             "intense": {"label": "Something Intense", "emoji": "üî•"},
         }
         ```

    2. In `frontend/src/lib/api.ts`, add:
       ```typescript
       export interface MoodOption {
         id: string;
         label: string;
         emoji: string;
       }

       export async function fetchMoods(): Promise<MoodOption[]> {
         const res = await fetch(`${API_URL}/api/movies/moods`, { cache: "no-store" });
         if (!res.ok) throw new Error(res.statusText);
         return res.json();
       }

       export async function fetchMoviesByMood(mood: string, page: number = 1): Promise<PaginatedResponse<Movie>> {
         const res = await fetch(`${API_URL}/api/movies/mood/${mood}?page=${page}`, { cache: "no-store" });
         if (!res.ok) throw new Error(res.statusText);
         return res.json();
       }
       ```

    3. Create `frontend/src/hooks/useMoodRecommendations.ts`:
       - Export `useMoodRecommendations(mood: string | null)` hook
       - queryKey: ['movies-mood', mood]
       - enabled: !!mood (only fetch when mood is selected)
       - Calls fetchMoviesByMood, returns data
       - staleTime: 1000 * 60 * 5
       - Also export `useMoods()` hook:
         * queryKey: ['moods']
         * Calls fetchMoods
         * staleTime: 1000 * 60 * 60 (moods are static, cache for 1 hour)
  </action>
  <verify>
    Run `curl http://localhost:8000/api/movies/moods` to confirm mood list returns. Run `curl http://localhost:8000/api/movies/mood/adventurous` to confirm mood-filtered movies return. Run `cd /Users/zacharym/netflixrecs/frontend && npx next build` to verify compilation.
  </verify>
  <done>Backend serves mood options and mood-filtered movie lists. Frontend hooks and API functions exist for fetching mood data and mood-based movies.</done>
</task>

<task type="auto">
  <name>Task 2: MoodSelector UI + browse page integration + dark mode audit</name>
  <files>
    frontend/src/components/discovery/MoodSelector.tsx
    frontend/src/app/browse/page.tsx
    frontend/src/app/globals.css
  </files>
  <action>
    1. Create `frontend/src/components/discovery/MoodSelector.tsx` ("use client"):
       - Import useMoods from @/hooks/useMoodRecommendations, framer-motion motion
       - Props: `selectedMood: string | null`, `onMoodSelect: (mood: string | null) => void`
       - Layout:
         * Section with heading: "What are you in the mood for?" (text-lg font-semibold text-white mb-4)
         * Horizontal scrollable flex row of mood buttons (flex gap-3 overflow-x-auto scrollbar-hide pb-2)
         * Each mood button:
           - bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm text-slate-200 transition-all cursor-pointer whitespace-nowrap
           - When selected: bg-red-600/20 border-red-500 text-red-400 (active state)
           - Content: emoji + label (e.g., "üó∫Ô∏è Adventurous")
           - onClick: if already selected, call onMoodSelect(null) (toggle off), else onMoodSelect(mood.id)
           - framer-motion: whileHover={{ scale: 1.05 }}, whileTap={{ scale: 0.95 }}
       - Loading state while moods fetch: 5 skeleton pills (bg-slate-700 animate-pulse rounded-full h-10 w-32)

    2. Update `frontend/src/app/browse/page.tsx` to integrate mood selector:
       - Add state: `const [selectedMood, setSelectedMood] = useState<string | null>(null)`
       - Import MoodSelector from @/components/discovery/MoodSelector
       - Import useMoodRecommendations from @/hooks/useMoodRecommendations
       - Import Carousel (should already be imported from Plan 02)
       - Add hook: `const { data: moodData, isLoading: moodLoading } = useMoodRecommendations(selectedMood)`
       - Place MoodSelector ABOVE the carousels section:
         ```
         <MoodSelector selectedMood={selectedMood} onMoodSelect={setSelectedMood} />

         {/* Mood results carousel -- only show when mood is selected */}
         {selectedMood && (
           <Carousel
             title={`Movies for your "${selectedMood}" mood`}
             movies={moodData?.results ?? []}
             isLoading={moodLoading}
           />
         )}

         {/* Existing carousel rows... */}
         ```

    3. Dark mode global audit in `frontend/src/app/globals.css`:
       - Verify the existing CSS variables and body styles enforce #0f172a background and #e2e8f0 text
       - Add: `html { color-scheme: dark; }` to ensure browser UI elements (scrollbars, form controls) also render in dark mode
       - Add: `::selection { background-color: rgba(239, 68, 68, 0.3); color: white; }` for red-tinted text selection consistent with brand
       - The existing layout.tsx already sets `bg-slate-900 text-slate-200` on body and `className="dark"` on html -- this is correct
       - All components throughout the app already use slate-700/800/900 backgrounds and slate-200/300/400 text -- no individual component changes needed (verified by reading MovieCard, MovieDetail, Navbar, auth forms)

    Dark mode (REQ-UI-03) is already established via locked decisions. This task verifies global enforcement and adds minor polish (color-scheme, selection color).
  </action>
  <verify>
    Run `cd /Users/zacharym/netflixrecs/frontend && npx next build` to verify compilation. Visually verify at http://localhost:3000/browse:
    - Mood selector row appears with 8 emoji-labeled mood buttons
    - Clicking a mood shows a filtered carousel above the other carousels
    - Clicking the same mood again deselects it and hides the mood carousel
    - All pages consistently use dark mode (no white/light backgrounds anywhere)
  </verify>
  <done>MoodSelector component renders mood buttons with toggle selection. Selecting a mood shows a filtered carousel. Dark mode is consistently enforced app-wide with color-scheme: dark and brand-colored text selection.</done>
</task>

</tasks>

<verification>
- `curl http://localhost:8000/api/movies/moods` returns list of 8 mood options with labels and emoji
- `curl http://localhost:8000/api/movies/mood/cozy` returns drama/romance/family movies
- `curl http://localhost:8000/api/movies/mood/invalid` returns 400 with available moods
- Browse page shows mood selector with 8 mood buttons above carousels
- Clicking "Adventurous" shows action/adventure movies in a new carousel
- Clicking "Adventurous" again deselects and hides the mood carousel
- All pages (/, /browse, /movies/*, /profile) use dark backgrounds consistently
- `html { color-scheme: dark; }` is present in globals.css
- `npx next build` compiles without errors
</verification>

<success_criteria>
Users can select a mood from 8 options and see movies filtered to match that mood in a carousel. Moods map to genre combinations via the backend. Dark mode is consistently enforced across the entire application with proper color-scheme declaration.
</success_criteria>

<output>
After completion, create `.planning/phases/06-netflix-style-ui-discovery/06-03-SUMMARY.md`
</output>
