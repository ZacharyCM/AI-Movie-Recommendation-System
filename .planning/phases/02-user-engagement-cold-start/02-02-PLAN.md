---
phase: 02-user-engagement-cold-start
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/components/movies/MovieCard.tsx
  - frontend/src/components/movies/MovieDetail.tsx
  - frontend/src/app/movies/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "MovieCard shows StarRating and WatchlistButton overlays on hover"
    - "MovieDetail page shows StarRating and WatchlistButton in the backdrop info section"
    - "Viewing detail page tracks a 'detail_viewed' action in viewing_history"
    - "Ratings and watchlist state loads for authenticated users on both card and detail views"
  artifacts:
    - path: "frontend/src/components/movies/MovieCard.tsx"
      provides: "Movie card with engagement overlays"
      contains: "StarRating"
    - path: "frontend/src/components/movies/MovieDetail.tsx"
      provides: "Movie detail with rating and watchlist"
      contains: "WatchlistButton"
    - path: "frontend/src/app/movies/[id]/page.tsx"
      provides: "Detail page with viewing history tracking"
      contains: "trackAction"
  key_links:
    - from: "frontend/src/components/movies/MovieCard.tsx"
      to: "useMovieRating hook"
      via: "import from hooks"
      pattern: "useMovieRating"
    - from: "frontend/src/components/movies/MovieDetail.tsx"
      to: "useRateMovie hook"
      via: "import from hooks"
      pattern: "useRateMovie"
---

<objective>
Integrate StarRating and WatchlistButton components into the existing MovieCard and MovieDetail pages, and add viewing history tracking.

Purpose: The engagement components from 02-01 exist but aren't visible anywhere. This plan wires them into the browse grid (MovieCard) and detail page (MovieDetail) so users can rate and bookmark movies from both views. Also tracks detail page views as implicit engagement signals.

Output: MovieCard shows rating/watchlist on hover, MovieDetail shows them in the info section, and visiting a detail page logs a viewing_history entry.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-engagement-cold-start/02-RESEARCH.md
@frontend/src/components/movies/MovieCard.tsx
@frontend/src/components/movies/MovieDetail.tsx
@frontend/src/app/movies/[id]/page.tsx
@frontend/src/components/engagement/StarRating.tsx
@frontend/src/components/engagement/WatchlistButton.tsx
@frontend/src/hooks/useRatings.ts
@frontend/src/hooks/useWatchlist.ts
@frontend/src/lib/supabase/history.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add StarRating and WatchlistButton to MovieCard</name>
  <files>
    frontend/src/components/movies/MovieCard.tsx
  </files>
  <action>
Update `frontend/src/components/movies/MovieCard.tsx` to add engagement overlays.

**Changes:**
1. Import `StarRating` from `@/components/engagement/StarRating`
2. Import `WatchlistButton` from `@/components/engagement/WatchlistButton`
3. Import `useMovieRating` and `useRateMovie` from `@/hooks/useRatings`

4. Add a hover overlay to the card's poster area that shows StarRating (size="sm") and WatchlistButton (size="sm"). The overlay should:
   - Appear on hover using group-hover with a semi-transparent dark background (bg-slate-900/80)
   - Position at the bottom of the poster image area using absolute positioning
   - Show StarRating on the left and WatchlistButton on the right
   - Include `onClick={(e) => e.preventDefault()}` on the overlay container to prevent the Link navigation when interacting with rating/watchlist controls

5. Use `useMovieRating(movie.id)` to get the current rating and `useRateMovie()` for the mutation. Pass them to StarRating.

6. Keep the existing card layout and styling intact. The overlay is purely additive.

7. Replace the existing inline SVG star + vote_average display in the card footer with the user's personal rating if they have one (show "Your: ★ 4" style), falling back to the TMDB vote_average if no personal rating.

**Important:** The card is wrapped in a `<Link>` so engagement buttons must stop event propagation to prevent navigation. Use `e.preventDefault()` and `e.stopPropagation()` on the overlay container div.
  </action>
  <verify>
    - `grep "StarRating" frontend/src/components/movies/MovieCard.tsx` confirms import
    - `grep "WatchlistButton" frontend/src/components/movies/MovieCard.tsx` confirms import
    - `grep "preventDefault" frontend/src/components/movies/MovieCard.tsx` confirms click handling
    - `grep "useMovieRating\|useRateMovie" frontend/src/components/movies/MovieCard.tsx` confirms hooks
    - `cd frontend && npx tsc --noEmit` compiles
  </verify>
  <done>
    MovieCard shows StarRating and WatchlistButton on poster hover. Click on engagement controls doesn't trigger navigation. Personal rating replaces TMDB rating when available. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add engagement controls to MovieDetail and track detail views</name>
  <files>
    frontend/src/components/movies/MovieDetail.tsx
    frontend/src/app/movies/[id]/page.tsx
  </files>
  <action>
**MovieDetail component** (`frontend/src/components/movies/MovieDetail.tsx`):

1. Import `StarRating` from `@/components/engagement/StarRating` and `WatchlistButton` from `@/components/engagement/WatchlistButton`
2. Import `useMovieRating` and `useRateMovie` from `@/hooks/useRatings`
3. Add props: accept optional `movieId: number` prop (needed for hooks)

4. In the backdrop info section (the absolute-positioned bottom area with title/tagline/metadata), add a row below the existing metadata line containing:
   - StarRating (size="md") showing user's rating, with onChange wired to useRateMovie mutation
   - WatchlistButton (size="md") next to the rating
   - A text label "Rate this movie" or showing "Your rating: X/5" if already rated

5. Keep existing layout intact. The engagement row is an addition below the year/runtime/TMDB-rating line.

**Movie detail page** (`frontend/src/app/movies/[id]/page.tsx`):

1. Import `trackAction` from `@/lib/supabase/history`
2. Import `useEffect` from React (already using `use`)
3. Add a `useEffect` that calls `trackAction(Number(id), 'detail_viewed')` when the page loads (fires once per page visit). Wrap in a try/catch since it's a fire-and-forget operation — don't block rendering.
4. Pass `movieId={Number(id)}` prop to `<MovieDetail>` component.
  </action>
  <verify>
    - `grep "StarRating" frontend/src/components/movies/MovieDetail.tsx` confirms import
    - `grep "WatchlistButton" frontend/src/components/movies/MovieDetail.tsx` confirms import
    - `grep "trackAction" frontend/src/app/movies/\\[id\\]/page.tsx` confirms history tracking
    - `grep "useEffect" frontend/src/app/movies/\\[id\\]/page.tsx` confirms effect hook
    - `cd frontend && npx tsc --noEmit` compiles
  </verify>
  <done>
    MovieDetail shows StarRating and WatchlistButton in the backdrop section. Detail page view is tracked in viewing_history on load. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes: `cd frontend && npx tsc --noEmit`
- MovieCard has StarRating and WatchlistButton with click propagation prevention
- MovieDetail has engagement controls in backdrop info section
- Detail page tracks 'detail_viewed' via useEffect
- No layout regressions in existing card/detail styles
</verification>

<success_criteria>
- StarRating and WatchlistButton appear on movie cards (hover) and detail pages
- User can rate and bookmark from both views
- Detail page views are tracked as implicit engagement signals
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-engagement-cold-start/02-02-SUMMARY.md`
</output>
