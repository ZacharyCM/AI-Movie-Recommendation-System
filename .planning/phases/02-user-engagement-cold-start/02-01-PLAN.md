---
phase: 02-user-engagement-cold-start
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260213_user_engagement.sql
  - frontend/src/components/engagement/StarRating.tsx
  - frontend/src/components/engagement/WatchlistButton.tsx
  - frontend/src/lib/supabase/ratings.ts
  - frontend/src/lib/supabase/watchlist.ts
  - frontend/src/lib/supabase/profiles.ts
  - frontend/src/lib/supabase/history.ts
  - frontend/src/hooks/useRatings.ts
  - frontend/src/hooks/useWatchlist.ts
  - frontend/src/hooks/useProfile.ts
  - frontend/src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Supabase database has profiles, ratings, watchlist, and viewing_history tables with RLS policies"
    - "StarRating component renders 5 interactive stars with hover states and keyboard navigation"
    - "WatchlistButton component toggles add/remove with visual feedback"
    - "TanStack Query hooks provide optimistic mutations for ratings and watchlist"
  artifacts:
    - path: "supabase/migrations/20260213_user_engagement.sql"
      provides: "Database schema with tables, RLS policies, triggers, indexes"
      contains: "create table public.ratings"
    - path: "frontend/src/components/engagement/StarRating.tsx"
      provides: "Interactive star rating component"
      contains: "role=\"radiogroup\""
    - path: "frontend/src/components/engagement/WatchlistButton.tsx"
      provides: "Watchlist toggle button"
      contains: "watchlist"
    - path: "frontend/src/hooks/useRatings.ts"
      provides: "Rating mutation hook with optimistic updates"
      contains: "useMutation"
    - path: "frontend/src/hooks/useWatchlist.ts"
      provides: "Watchlist mutation hook with optimistic updates"
      contains: "useMutation"
    - path: "frontend/src/types/database.ts"
      provides: "TypeScript types for database tables"
      contains: "Rating"
  key_links:
    - from: "frontend/src/hooks/useRatings.ts"
      to: "supabase ratings table"
      via: "supabase.from('ratings').upsert()"
      pattern: "from\\(['\"]ratings['\"]\\)"
    - from: "frontend/src/hooks/useWatchlist.ts"
      to: "supabase watchlist table"
      via: "supabase.from('watchlist')"
      pattern: "from\\(['\"]watchlist['\"]\\)"
    - from: "frontend/src/components/engagement/StarRating.tsx"
      to: "onChange callback"
      via: "props.onChange"
      pattern: "onChange\\?\\("
---

<objective>
Create the database foundation and reusable UI components for user engagement features (ratings, watchlist, viewing history, profiles).

Purpose: Everything in Phase 2 depends on the Supabase schema existing and the engagement components being available. This plan builds the foundation layer: database tables with Row Level Security, reusable StarRating and WatchlistButton components, Supabase data access functions, and TanStack Query hooks with optimistic updates.

Output: Supabase migration SQL ready to run, StarRating and WatchlistButton components, typed data layer functions, and TanStack Query hooks for ratings/watchlist/profiles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-engagement-cold-start/02-RESEARCH.md

# Phase 1 patterns to follow
@frontend/src/lib/supabase/client.ts
@frontend/src/hooks/useAuth.ts
@frontend/src/types/movie.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase migration, install dependencies, and define database types</name>
  <files>
    supabase/migrations/20260213_user_engagement.sql
    frontend/src/types/database.ts
  </files>
  <action>
First, install new dependencies in the frontend directory:
```
npm install zod lucide-react
```

Create `supabase/migrations/20260213_user_engagement.sql` containing the complete database setup. Use the exact SQL from the research document (02-RESEARCH.md "Complete Supabase Setup" section):

1. **Tables**: profiles (extends auth.users with uuid PK, username text unique, avatar_url text, created_at, updated_at), ratings (uuid PK, user_id FK, movie_id integer, rating integer check 1-5, created_at, updated_at, unique(user_id, movie_id)), watchlist (uuid PK, user_id FK, movie_id integer, created_at, unique(user_id, movie_id)), viewing_history (uuid PK, user_id FK, movie_id integer, action_type text, created_at).

2. **Enable RLS** on all four tables.

3. **RLS Policies**: Profiles viewable by everyone (select using true), users update own profile. Ratings full CRUD restricted to own user_id via `(select auth.uid()) = user_id`. Watchlist select/insert/delete restricted to own user_id. Viewing_history select/insert restricted to own user_id. Use `(select auth.uid())` pattern (NOT `auth.uid()` directly -- subselect is more performant per Supabase docs).

4. **Trigger**: `handle_new_user()` function with `security definer set search_path = ''` that auto-creates a profiles row on auth.users insert, extracting username and avatar_url from `new.raw_user_meta_data`.

5. **Indexes**: Create indexes on ALL foreign key columns (ratings.user_id, ratings.movie_id, ratings.created_at DESC, watchlist.user_id, watchlist.movie_id, viewing_history.user_id, viewing_history.movie_id, viewing_history.created_at DESC, viewing_history.action_type). Supabase does NOT auto-create FK indexes.

Create `frontend/src/types/database.ts` with TypeScript interfaces:
- `Profile`: { id: string, username: string | null, avatar_url: string | null, created_at: string, updated_at: string }
- `Rating`: { id: string, user_id: string, movie_id: number, rating: number, created_at: string, updated_at: string }
- `WatchlistItem`: { id: string, user_id: string, movie_id: number, created_at: string }
- `ViewingHistoryEntry`: { id: string, user_id: string, movie_id: number, action_type: 'rated' | 'watchlisted' | 'detail_viewed', created_at: string }
- `UserStats`: { total_ratings: number, total_watchlist: number, average_rating: number, favorite_genre: string | null, member_since: string }

Note: The SQL file is a migration script the user will run against their Supabase project (via Supabase Dashboard SQL Editor or `supabase db push`). Include a header comment explaining this.
  </action>
  <verify>
    - `ls supabase/migrations/20260213_user_engagement.sql` confirms file exists
    - `grep "create table public.profiles" supabase/migrations/20260213_user_engagement.sql` confirms profiles table
    - `grep "create table public.ratings" supabase/migrations/20260213_user_engagement.sql` confirms ratings table
    - `grep "enable row level security" supabase/migrations/20260213_user_engagement.sql` confirms RLS
    - `grep "create index" supabase/migrations/20260213_user_engagement.sql` confirms indexes
    - `grep "handle_new_user" supabase/migrations/20260213_user_engagement.sql` confirms trigger
    - `cd frontend && npx tsc --noEmit` confirms TypeScript compiles
    - `ls frontend/node_modules/lucide-react` confirms lucide-react installed
    - `ls frontend/node_modules/zod` confirms zod installed
  </verify>
  <done>
    Migration SQL file contains all four tables, RLS policies for every table, auto-profile trigger with security definer, and indexes on all FK columns. TypeScript types file compiles and exports Profile, Rating, WatchlistItem, ViewingHistoryEntry, UserStats interfaces. Zod and lucide-react are installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build StarRating component, WatchlistButton component, data layer, and TanStack Query hooks</name>
  <files>
    frontend/src/components/engagement/StarRating.tsx
    frontend/src/components/engagement/WatchlistButton.tsx
    frontend/src/lib/supabase/ratings.ts
    frontend/src/lib/supabase/watchlist.ts
    frontend/src/lib/supabase/profiles.ts
    frontend/src/lib/supabase/history.ts
    frontend/src/hooks/useRatings.ts
    frontend/src/hooks/useWatchlist.ts
    frontend/src/hooks/useProfile.ts
  </files>
  <action>
**StarRating Component** (`frontend/src/components/engagement/StarRating.tsx`):
Build a custom accessible star rating component using Lucide React's `Star` icon. Follow the exact pattern from 02-RESEARCH.md "Accessible Star Rating Component" section. Key requirements:
- Props: `value: number`, `onChange?: (rating: number) => void`, `readonly?: boolean`, `size?: 'sm' | 'md' | 'lg'`, `className?: string`
- `'use client'` directive at top
- `role="radiogroup"` with `aria-label="Movie rating"` on container
- Each star is a `<button>` with `role="radio"`, `aria-checked`, `aria-setsize={5}`, `aria-posinset={star}`, `aria-label` like "1 star", "2 stars"
- Keyboard navigation: ArrowRight/ArrowLeft to move focus between stars, Enter/Space to select, Escape to blur
- Hover state tracking with `useState(0)` for hoverValue
- Visual: filled stars use `fill-yellow-400 text-yellow-400`, empty stars use `fill-none text-slate-600`
- Sizes: sm=16px, md=24px, lg=32px icon size
- Focus ring: `focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-slate-900`
- `tabIndex` management: checked star (or first if none checked) gets tabIndex=0, others get -1

**WatchlistButton Component** (`frontend/src/components/engagement/WatchlistButton.tsx`):
- `'use client'` directive
- Props: `movieId: number`, `size?: 'sm' | 'md' | 'lg'`, `className?: string`
- Uses the `useWatchlist` hook (created below) to check if movie is watchlisted and to toggle
- Renders Lucide `Bookmark` icon (outline when not watchlisted, `BookmarkCheck` or filled when watchlisted)
- On click, calls toggle mutation
- Shows loading state during mutation (subtle opacity change, NOT a spinner)
- Accessible: `aria-label="Add to watchlist"` / `"Remove from watchlist"` based on state
- Colors: watchlisted = `text-green-400`, not watchlisted = `text-slate-400 hover:text-slate-200`

**Supabase Data Layer Functions**:

`frontend/src/lib/supabase/ratings.ts`:
- `getUserRatings()`: Fetch all ratings for current user, returns Rating[]
- `getMovieRating(movieId: number)`: Fetch current user's rating for specific movie, returns number | null
- `upsertRating(movieId: number, rating: number)`: Upsert rating (insert or update), returns Rating
- `deleteRating(movieId: number)`: Delete rating for movie
- All functions use `createClient()` from `@/lib/supabase/client` and call `supabase.auth.getUser()` to get user_id

`frontend/src/lib/supabase/watchlist.ts`:
- `getUserWatchlist()`: Fetch all watchlist items for current user
- `isMovieWatchlisted(movieId: number)`: Check if specific movie is in watchlist, returns boolean
- `addToWatchlist(movieId: number)`: Insert watchlist item
- `removeFromWatchlist(movieId: number)`: Delete watchlist item
- `toggleWatchlist(movieId: number)`: Check current state and toggle (add if not present, remove if present)

`frontend/src/lib/supabase/profiles.ts`:
- `getProfile()`: Fetch current user's profile
- `updateProfile(updates: { username?: string, avatar_url?: string })`: Update profile fields
- `getUserStats()`: Fetch aggregated stats -- count of ratings, count of watchlist, average rating. Use separate queries (Supabase JS client doesn't support aggregate functions directly, so fetch all ratings and compute client-side, or use a simple `.select('rating')` and compute average).

`frontend/src/lib/supabase/history.ts`:
- `trackAction(movieId: number, actionType: 'rated' | 'watchlisted' | 'detail_viewed')`: Insert viewing history entry
- `getViewingHistory(limit?: number)`: Fetch recent history entries, ordered by created_at desc

**TanStack Query Hooks**:

`frontend/src/hooks/useRatings.ts`:
- `useMovieRating(movieId: number)`: useQuery hook returning current user's rating for a specific movie. Query key: `['ratings', movieId]`.
- `useUserRatings()`: useQuery hook returning all user ratings. Query key: `['user-ratings']`.
- `useRateMovie()`: useMutation hook following the EXACT optimistic update pattern from 02-RESEARCH.md. Key details:
  - `mutationKey: ['ratings']`
  - `onMutate`: cancel queries for `['ratings', movieId]` AND `['user-ratings']`, snapshot both, optimistically update both caches
  - `onError`: rollback both caches from context
  - `onSettled`: only invalidate if `queryClient.isMutating({ mutationKey: ['ratings'] }) === 1` (prevents over-invalidation)
  - Also call `trackAction(movieId, 'rated')` in the mutationFn after successful upsert

`frontend/src/hooks/useWatchlist.ts`:
- `useUserWatchlist()`: useQuery hook returning all watchlist items. Query key: `['user-watchlist']`.
- `useIsWatchlisted(movieId: number)`: useQuery hook checking if specific movie is watchlisted. Query key: `['watchlist', movieId]`.
- `useToggleWatchlist()`: useMutation hook with optimistic updates:
  - Optimistically toggle the `['watchlist', movieId]` cache and update `['user-watchlist']` list
  - Rollback on error
  - Also call `trackAction(movieId, 'watchlisted')` in mutationFn on add (not on remove)

`frontend/src/hooks/useProfile.ts`:
- `useProfile()`: useQuery hook returning user profile. Query key: `['profile']`.
- `useUserStats()`: useQuery hook returning computed stats. Query key: `['user-stats']`.
- `useUpdateProfile()`: useMutation hook for profile updates with cache invalidation.

All hooks must import `createClient` from `@/lib/supabase/client` and use the typed data layer functions. Do NOT use `any` types -- use the database types from `@/types/database.ts`.
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` passes with no errors
    - `grep -r "useMutation" frontend/src/hooks/useRatings.ts` confirms mutation hook exists
    - `grep -r "useMutation" frontend/src/hooks/useWatchlist.ts` confirms mutation hook exists
    - `grep "role=\"radiogroup\"" frontend/src/components/engagement/StarRating.tsx` confirms accessibility
    - `grep "Bookmark" frontend/src/components/engagement/WatchlistButton.tsx` confirms icon usage
    - `grep "cancelQueries" frontend/src/hooks/useRatings.ts` confirms optimistic update pattern
    - `grep "trackAction" frontend/src/hooks/useRatings.ts` confirms history tracking in mutation
  </verify>
  <done>
    StarRating renders 5 accessible stars with hover, keyboard nav, and size variants. WatchlistButton toggles bookmark state with optimistic feedback. All data layer functions typed and working against Supabase tables. TanStack Query hooks implement full optimistic update pattern with rollback and history tracking. TypeScript compiles with no errors.
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes: `cd frontend && npx tsc --noEmit`
- All migration SQL contains required elements (tables, RLS, trigger, indexes)
- StarRating component has ARIA radiogroup pattern
- Hooks implement optimistic update pattern (cancelQueries, snapshot, rollback)
- No `any` types used in hooks or data layer
- Lucide-react and zod installed in frontend/package.json
</verification>

<success_criteria>
- Supabase migration SQL is complete and ready to run
- StarRating and WatchlistButton components are self-contained and reusable
- Data layer provides typed CRUD for ratings, watchlist, profiles, and history
- TanStack Query hooks implement optimistic mutations with proper rollback
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-engagement-cold-start/02-01-SUMMARY.md`
</output>
