---
phase: 02-user-engagement-cold-start
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/app/(auth)/taste-quiz/page.tsx
  - frontend/src/components/onboarding/TasteQuizCard.tsx
  - frontend/src/components/onboarding/TasteQuizProgress.tsx
  - frontend/src/lib/taste-quiz.ts
  - frontend/src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "New users are redirected to /taste-quiz before accessing the main experience"
    - "Taste quiz presents 8-10 well-known movies across diverse genres for rating"
    - "User can rate movies with StarRating component and skip movies they haven't seen"
    - "After completing the quiz (minimum 5 ratings), user is redirected to /browse"
    - "Quiz ratings are persisted to Supabase ratings table via existing hooks"
    - "Returning users who have completed the quiz bypass it on subsequent logins"
  artifacts:
    - path: "frontend/src/app/(auth)/taste-quiz/page.tsx"
      provides: "Taste quiz onboarding page"
      contains: "TasteQuizCard"
    - path: "frontend/src/components/onboarding/TasteQuizCard.tsx"
      provides: "Individual movie card for taste quiz"
      contains: "StarRating"
    - path: "frontend/src/components/onboarding/TasteQuizProgress.tsx"
      provides: "Progress indicator for quiz completion"
      contains: "progress"
    - path: "frontend/src/lib/taste-quiz.ts"
      provides: "Curated movie list and quiz logic"
      contains: "TASTE_QUIZ_MOVIES"
    - path: "frontend/src/middleware.ts"
      provides: "Redirect logic for new users to taste quiz"
      contains: "taste-quiz"
  key_links:
    - from: "frontend/src/app/(auth)/taste-quiz/page.tsx"
      to: "useRateMovie hook"
      via: "import from hooks"
      pattern: "useRateMovie"
    - from: "frontend/src/middleware.ts"
      to: "taste-quiz redirect"
      via: "redirect check"
      pattern: "taste-quiz"
---

<objective>
Build the taste quiz onboarding flow that solves the cold start problem by having new users rate well-known movies.

Purpose: REQ-REC-04 requires a taste quiz at signup so the recommendation engine has data from the user's first session. Without this, Phase 3's content-based filtering has nothing to work with. The quiz presents popular, genre-diverse movies and collects at least 5 ratings.

Output: /taste-quiz page with curated movie cards, StarRating integration, progress tracking, minimum-rating gate, middleware redirect for new users, and bypass for returning users.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-engagement-cold-start/02-RESEARCH.md
@frontend/src/middleware.ts
@frontend/src/app/(auth)/layout.tsx
@frontend/src/components/engagement/StarRating.tsx
@frontend/src/hooks/useRatings.ts
@frontend/src/lib/supabase/client.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create taste quiz data, components, and progress indicator</name>
  <files>
    frontend/src/lib/taste-quiz.ts
    frontend/src/components/onboarding/TasteQuizCard.tsx
    frontend/src/components/onboarding/TasteQuizProgress.tsx
  </files>
  <action>
**Taste quiz data** (`frontend/src/lib/taste-quiz.ts`):
- Export `TASTE_QUIZ_MOVIES` array with 10 curated movies. Each entry has: `tmdbId: number`, `title: string`, `genre: string` (human-readable genre label for diversity display).
- Use well-known, high-popularity TMDB IDs. Suggested selection covering diverse genres:
  - 550: Fight Club (thriller)
  - 13: Forrest Gump (drama)
  - 155: The Dark Knight (action)
  - 122: Lord of the Rings: Return of the King (fantasy)
  - 680: Pulp Fiction (crime)
  - 27205: Inception (sci-fi)
  - 238: The Godfather (crime/drama)
  - 603: The Matrix (sci-fi/action)
  - 862: Toy Story (animation)
  - 11: Star Wars: A New Hope (sci-fi/adventure)
- Export `MINIMUM_RATINGS = 5` constant
- Export helper `hasCompletedTasteQuiz(ratingCount: number): boolean` that checks `ratingCount >= MINIMUM_RATINGS`

**TasteQuizCard** (`frontend/src/components/onboarding/TasteQuizCard.tsx`):
- `'use client'` directive
- Props: `tmdbId: number`, `onRate: (rating: number) => void`, `currentRating: number`, `onSkip: () => void`
- Fetch movie details using `useQuery` with `fetchMovieDetail(tmdbId)` from `@/lib/api`
- Display:
  - Large movie poster (w-48 or similar)
  - Movie title and year
  - Genre tags from TMDB
  - Brief overview (truncated to 2-3 lines)
  - StarRating component (size="lg") for rating
  - "Haven't seen it" skip button (text link style, slate-400)
- Card layout: Centered, generous padding, slate-800 bg with rounded-xl
- Loading skeleton while movie data fetches

**TasteQuizProgress** (`frontend/src/components/onboarding/TasteQuizProgress.tsx`):
- `'use client'` directive
- Props: `rated: number`, `total: number`, `minimum: number`
- Display:
  - Progress bar (bg-slate-700 track, bg-red-600 fill, rounded-full, h-2)
  - Text: "X of Y movies rated" below the bar
  - When rated >= minimum, show "You're ready! Continue to browse" in green text
  - Visual indicator showing minimum threshold on the progress bar (small marker at the minimum point)
  </action>
  <verify>
    - `ls frontend/src/lib/taste-quiz.ts` exists
    - `grep "TASTE_QUIZ_MOVIES" frontend/src/lib/taste-quiz.ts` confirms curated list
    - `grep "MINIMUM_RATINGS" frontend/src/lib/taste-quiz.ts` confirms constant
    - `ls frontend/src/components/onboarding/TasteQuizCard.tsx` exists
    - `grep "StarRating" frontend/src/components/onboarding/TasteQuizCard.tsx` confirms integration
    - `ls frontend/src/components/onboarding/TasteQuizProgress.tsx` exists
    - `cd frontend && npx tsc --noEmit` compiles
  </verify>
  <done>
    Taste quiz data module with 10 curated movies and minimum threshold. TasteQuizCard shows movie details with large StarRating. TasteQuizProgress shows completion progress with minimum threshold marker. All compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create taste quiz page and add middleware redirect for new users</name>
  <files>
    frontend/src/app/(auth)/taste-quiz/page.tsx
    frontend/src/middleware.ts
  </files>
  <action>
**Taste quiz page** (`frontend/src/app/(auth)/taste-quiz/page.tsx`):
- `'use client'` directive
- Import: `TASTE_QUIZ_MOVIES`, `MINIMUM_RATINGS`, `hasCompletedTasteQuiz` from `@/lib/taste-quiz`
- Import: `TasteQuizCard` from `@/components/onboarding/TasteQuizCard`
- Import: `TasteQuizProgress` from `@/components/onboarding/TasteQuizProgress`
- Import: `useRateMovie` from `@/hooks/useRatings`
- Import: `useRouter` from `next/navigation`

- State management:
  - `currentIndex: number` — which movie is currently shown (0-based)
  - `ratings: Map<number, number>` — map of tmdbId -> rating for movies rated in this quiz
  - `skipped: Set<number>` — set of tmdbId that were skipped

- Flow:
  1. Show one movie at a time (TasteQuizCard) with a large centered card
  2. When user rates (via StarRating onChange), call `useRateMovie().mutate()` to persist, add to ratings map, advance to next movie
  3. When user clicks "Haven't seen it", add to skipped set, advance to next movie
  4. Show TasteQuizProgress above the card
  5. When all 10 movies are shown (or user has rated >= MINIMUM_RATINGS and viewed all), show a completion screen
  6. Completion screen: "Great taste! We're ready to recommend movies for you." with a "Start Browsing" button that navigates to /browse

- Page layout:
  - Centered, max-w-lg mx-auto
  - Header: "Let's learn your taste" with subtitle "Rate movies you've seen so we can recommend ones you'll love"
  - Dark theme consistent with app (bg-slate-900)
  - No Navbar (uses (auth) layout group which doesn't have one)

- Edge case: If user has already completed taste quiz (check useUserRatings count >= MINIMUM_RATINGS on load), redirect to /browse immediately

**Middleware update** (`frontend/src/middleware.ts`):
- Add `/taste-quiz` to the `publicPaths` array so it's accessible
- Add logic: For authenticated users navigating to `/browse` or `/movies`, check if they need the taste quiz by looking for a cookie or checking rating count:
  - **Approach:** Use a simple cookie flag `taste-quiz-complete=true` that gets set when the user completes the quiz. This avoids a Supabase query on every request.
  - In middleware: If user has session but NO `taste-quiz-complete` cookie and path is NOT `/taste-quiz`, redirect to `/taste-quiz`
  - The taste quiz page sets this cookie after completion (via document.cookie or a server action)
  - Note: The cookie approach is lightweight. The taste quiz page also checks rating count as a fallback — if a user somehow has >= 5 ratings without the cookie, it sets the cookie and redirects to /browse

**Important:** The (auth) route group layout already exists and provides a centered, minimal layout suitable for the quiz. The taste-quiz page should be placed inside this group.
  </action>
  <verify>
    - `ls frontend/src/app/\\(auth\\)/taste-quiz/page.tsx` exists
    - `grep "TASTE_QUIZ_MOVIES" frontend/src/app/\\(auth\\)/taste-quiz/page.tsx` confirms quiz data
    - `grep "useRateMovie" frontend/src/app/\\(auth\\)/taste-quiz/page.tsx` confirms rating integration
    - `grep "taste-quiz" frontend/src/middleware.ts` confirms middleware redirect
    - `grep "taste-quiz-complete" frontend/src/middleware.ts` confirms cookie check
    - `cd frontend && npx tsc --noEmit` compiles
  </verify>
  <done>
    Taste quiz page presents 10 curated movies one at a time for rating. Ratings persist via Supabase hooks. Progress bar shows completion status. Middleware redirects new users to quiz. Cookie flag bypasses quiz for returning users. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes: `cd frontend && npx tsc --noEmit`
- Taste quiz page renders at /taste-quiz within (auth) layout
- 10 curated, genre-diverse movies in quiz data
- StarRating integration works for quiz ratings
- Progress bar shows rated count vs. minimum threshold
- Middleware redirects new users to /taste-quiz
- Returning users with cookie bypass quiz
- Completion redirects to /browse
</verification>

<success_criteria>
- New users are prompted to rate movies at signup before seeing the main experience
- Quiz presents 8-10 well-known movies across diverse genres
- User can rate or skip each movie
- Minimum 5 ratings required before continuing
- Ratings persist to Supabase ratings table
- Returning users bypass the quiz
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-engagement-cold-start/02-04-SUMMARY.md`
</output>
